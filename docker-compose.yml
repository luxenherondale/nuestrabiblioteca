version: '3.8'

services:
  server:
    build:
      context: .
      dockerfile: Dockerfile.server
    container_name: nuestrabiblioteca-server
    environment:
      MONGODB_URI: ${MONGODB_URI}
      JWT_SECRET: ${JWT_SECRET}
      PORT: 5000
      NODE_ENV: production
    volumes:
      - uploads:/app/server/uploads
    networks:
      - dokploy-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nuestrabiblioteca-api.rule=Host(`${DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.nuestrabiblioteca-api.entrypoints=websecure"
      - "traefik.http.routers.nuestrabiblioteca-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.nuestrabiblioteca-api.loadbalancer.server.port=5000"
      - "traefik.http.routers.nuestrabiblioteca-api.priority=100"
      - "traefik.http.routers.nuestrabiblioteca-uploads.rule=Host(`${DOMAIN}`) && PathPrefix(`/uploads`)"
      - "traefik.http.routers.nuestrabiblioteca-uploads.entrypoints=websecure"
      - "traefik.http.routers.nuestrabiblioteca-uploads.tls.certresolver=letsencrypt"
      - "traefik.http.routers.nuestrabiblioteca-uploads.priority=100"
      - "traefik.http.services.nuestrabiblioteca-uploads.loadbalancer.server.port=5000"

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: nuestrabiblioteca-frontend
    depends_on:
      - server
    networks:
      - dokploy-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nuestrabiblioteca-frontend.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.nuestrabiblioteca-frontend.entrypoints=websecure"
      - "traefik.http.routers.nuestrabiblioteca-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.nuestrabiblioteca-frontend.loadbalancer.server.port=80"
      - "traefik.http.routers.nuestrabiblioteca-frontend.priority=1"

volumes:
  uploads:

networks:
  dokploy-network:
    external: true
